# Fail2ban jail configuration for OpenSIPS brute force detection
# Combines failed registration attempts and door-knock attempts
# This jail monitors both attack vectors and bans IPs that exceed thresholds

[opensips-brute-force]

# Enable this jail
enabled = true

# Ports to ban (SIP typically uses 5060/udp, but may also use TCP/TLS)
# Adjust based on your OpenSIPS configuration
port = 5060
protocol = udp

# Log source configuration
# Option 1: Systemd journal (recommended for systemd services)
# Use this if OpenSIPS logs to systemd journal (journalctl)
backend = systemd
journalmatch = _SYSTEMD_UNIT=opensips.service

# Option 2: Log file (uncomment if using file-based logging)
# Common locations:
# - /var/log/opensips/opensips.log
# - /var/log/syslog (if using syslog)
# - /var/log/messages (some systems)
# logpath = /var/log/opensips/opensips.log
# backend = auto

# Use combined filter (monitors both failed registrations and door-knock attempts)
# The combined filter matches patterns from both attack vectors
# Alternative: Use separate jails (opensips-failed-registrations and opensips-door-knock) if preferred

# Combined filter (recommended - monitors both attack types)
filter = opensips-combined

# Alternative: Use separate filters (uncomment to use individual filters instead)
# filter = opensips-failed-registrations
# filter = opensips-door-knock

# Maximum number of failures before banning
# This is the total count from both failed registrations and door-knock attempts
# Adjust based on your security requirements:
# - Lower values (5-10) = more aggressive blocking
# - Higher values (20-30) = less aggressive, fewer false positives
maxretry = 10

# Time window to count failures (in seconds)
# Failures within this window count toward maxretry
# 300 seconds = 5 minutes
findtime = 300

# Ban duration (in seconds)
# 3600 seconds = 1 hour
# 86400 seconds = 24 hours
# Adjust based on your security policy
bantime = 3600

# Action to take when ban is triggered
# iptables is the default and recommended action
# This adds an iptables rule to block the IP
action = iptables[name=OPENSIPS, port=5060, protocol=udp]

# Alternative actions (uncomment if needed):
# - Send email notification:
# action = iptables[name=OPENSIPS, port=5060, protocol=udp]
#          sendmail-whois[name=OPENSIPS, dest=admin@example.com, sender=fail2ban@example.com]
# - Use custom action script:
# action = %(action_)s[name=OPENSIPS, port=5060, protocol=udp]
#          /path/to/custom/action.sh

# Whitelist (ignoreip) - IPs and ranges that should NEVER be banned
# CRITICAL: In production, clusters of endpoints often share the same public IP (NAT)
# If one misconfigured phone triggers Fail2ban, it could block the entire cluster
# Always whitelist trusted customer IPs/ranges to prevent accidental blocking
#
# Format: Space-separated list of IPs and CIDR ranges
# Examples:
#   ignoreip = 203.0.113.50                    # Single IP
#   ignoreip = 203.0.113.0/24                  # CIDR range
#   ignoreip = 203.0.113.50 198.51.100.0/24  # Multiple entries
#
# Default: Uncomment to whitelist localhost and private ranges (recommended for testing)
# ignoreip = 127.0.0.1/8 ::1 10.0.0.0/8 172.16.0.0/12 192.168.0.0/16
#
# Production: Add your trusted customer IPs/ranges here
# Use the manage-fail2ban-whitelist.sh script to manage this list
# ignoreip = 203.0.113.50 203.0.113.51 198.51.100.0/24

# Notes:
# - This jail combines both failed registrations and door-knock attempts
# - If you prefer separate jails, create opensips-failed-registrations.conf and opensips-door-knock.conf
# - Adjust maxretry, findtime, and bantime based on your security requirements
# - Test the configuration before deploying to production
# - Monitor the first few bans to ensure they're working correctly
