# Fail2ban filter for OpenSIPS door-knock attempts
# Monitors OpenSIPS logs for door-knock attempts (unknown domains, scanners, invalid methods, etc.)
# This filter detects extension scanning and reconnaissance attacks

[Definition]

# Failregex patterns to match door-knock attempt log entries
# Multiple log formats are supported:

# Pattern 1: "Door-knock blocked: domain=example.com src=IP (query failed)"
# Pattern 2: "Door-knock blocked: domain=example.com src=IP (not found)"
# Pattern 3: "Door-knock attempt logged to database - domain=example.com from IP:PORT (query failed)"
# Pattern 4: "Door-knock attempt logged to database - domain=example.com from IP:PORT"
# Pattern 5: "Scanner detected and logged to database - user_agent=... from IP:PORT"
# Pattern 6: "Door-knock attempt logged to database - domain mismatch ... from IP:PORT"

failregex = ^.*Door-knock blocked: domain=.* src=<HOST> \(query failed\)$
            ^.*Door-knock blocked: domain=.* src=<HOST> \(not found\)$
            ^.*Door-knock attempt logged to database - domain=.* from <HOST>:\d+ \(query failed\)$
            ^.*Door-knock attempt logged to database - domain=.* from <HOST>:\d+$
            ^.*Scanner detected and logged to database - user_agent=.* from <HOST>:\d+$
            ^.*Door-knock attempt logged to database - domain mismatch .* from <HOST>:\d+$
            ^.*Door-knock blocked: domain=.* src=<HOST> \(domain mismatch\)$

# Date/time pattern (OpenSIPS default log format)
# OpenSIPS logs typically include timestamp, adjust if your log format differs
# Common formats:
# - Syslog: "Jan 15 10:30:45 hostname opensips: ..."
# - Custom: Check your OpenSIPS log format
# This pattern should match your actual log format
datepattern = {^LN-BEG}%%Y-%%m-%%d %%H:%%M:%%S

# Notes:
# - <HOST> is a Fail2ban placeholder that matches IP addresses (IPv4 and IPv6)
# - This filter catches various door-knock scenarios:
#   * Unknown domains (domain not found)
#   * Domain query failures
#   * Scanner detection (sipvicious, friendly-scanner, sipcli, nmap)
#   * Domain mismatches
#   * Method not allowed (logged elsewhere but may appear here)
# - Adjust datepattern to match your actual OpenSIPS log format
# - If using syslog, you may need to adjust the datepattern or use syslog-specific patterns
