# Fail2ban combined filter for OpenSIPS brute force detection
# Monitors both failed registration attempts and door-knock attempts
# This filter combines patterns from both attack vectors

[Definition]

# Failregex patterns for failed registration attempts
# Log format: "REGISTER: Failed registration logged to database - user@domain from IP:PORT, response CODE REASON"
failregex = ^.*REGISTER: Failed registration logged to database - .* from <HOST>:\d+, response \d+ .*$
            ^.*REGISTER: Failed registration logged to database - .* from <HOST>:\d+, response 403 .*$
            ^.*REGISTER: Failed registration logged to database - .* from <HOST>:\d+, response 4\d{2} .*$
            ^.*REGISTER: Failed registration logged to database - .* from <HOST>:\d+, response 5\d{2} .*$

# Failregex patterns for door-knock attempts
# Pattern 1: "Door-knock blocked: domain=example.com src=IP (query failed)"
# Pattern 2: "Door-knock blocked: domain=example.com src=IP (not found)"
# Pattern 3: "Door-knock attempt logged to database - domain=example.com from IP:PORT (query failed)"
# Pattern 4: "Door-knock attempt logged to database - domain=example.com from IP:PORT"
# Pattern 5: "Scanner detected and logged to database - user_agent=... from IP:PORT"
# Pattern 6: "Door-knock attempt logged to database - domain mismatch ... from IP:PORT"
            ^.*Door-knock blocked: domain=.* src=<HOST> \(query failed\)$
            ^.*Door-knock blocked: domain=.* src=<HOST> \(not found\)$
            ^.*Door-knock attempt logged to database - domain=.* from <HOST>:\d+ \(query failed\)$
            ^.*Door-knock attempt logged to database - domain=.* from <HOST>:\d+$
            ^.*Scanner detected and logged to database - user_agent=.* from <HOST>:\d+$
            ^.*Door-knock attempt logged to database - domain mismatch .* from <HOST>:\d+$
            ^.*Door-knock blocked: domain=.* src=<HOST> \(domain mismatch\)$

# Ignore 401 Unauthorized (normal part of authentication flow)
ignoreregex = ^.*REGISTER: Failed registration logged to database - .* from <HOST>:\d+, response 401 .*$

# Date/time pattern (OpenSIPS default log format)
# OpenSIPS logs typically include timestamp, adjust if your log format differs
# Common formats:
# - Syslog: "Jan 15 10:30:45 hostname opensips: ..."
# - Custom: Check your OpenSIPS log format
# This pattern should match your actual log format
datepattern = {^LN-BEG}%%Y-%%m-%%d %%H:%%M:%%S

# Notes:
# - <HOST> is a Fail2ban placeholder that matches IP addresses (IPv4 and IPv6)
# - This filter combines both failed registrations and door-knock attempts
# - The filter will match any failed registration (403, 4xx, 5xx) except 401
# - Door-knock patterns catch various scenarios: unknown domains, scanners, domain mismatches
# - Adjust datepattern to match your actual OpenSIPS log format
# - If using syslog, you may need to adjust the datepattern or use syslog-specific patterns
