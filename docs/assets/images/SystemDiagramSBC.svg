<?xml version="1.0" encoding="UTF-8"?>
<svg width="1600" height="850" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <linearGradient id="sbcGradient" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#4A90E2;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#357ABD;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="dbGradient" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#7B68EE;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#5B4FC7;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="cloudGradient" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#FFA500;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#FF8C00;stop-opacity:1" />
    </linearGradient>
    <filter id="shadow">
      <feDropShadow dx="2" dy="2" stdDeviation="3" flood-opacity="0.3"/>
    </filter>
    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#333" />
    </marker>
    <marker id="arrowhead-reverse" markerWidth="10" markerHeight="10" refX="1" refY="3" orient="auto">
      <polygon points="10 0, 0 3, 10 6" fill="#333" />
    </marker>
  </defs>
  
  <!-- Background -->
  <rect width="1600" height="850" fill="#F5F5F5"/>
  
  <!-- Title -->
  <text x="800" y="30" font-family="Arial, sans-serif" font-size="24" font-weight="bold" text-anchor="middle" fill="#333">PBX3sbc SIP Edge Router Architecture</text>
  
  <!-- Standard box dimensions: width=200, height=140 -->
  
  <!-- MySQL Database (top row) -->
  <rect x="450" y="60" width="200" height="140" rx="10" fill="url(#dbGradient)" stroke="#4A3A8A" stroke-width="2" filter="url(#shadow)"/>
  <text x="550" y="90" font-family="Arial, sans-serif" font-size="16" font-weight="bold" text-anchor="middle" fill="white">MySQL</text>
  <text x="550" y="115" font-family="Arial, sans-serif" font-size="12" text-anchor="middle" fill="white">Routing Database</text>
  <text x="550" y="140" font-family="Arial, sans-serif" font-size="11" text-anchor="middle" fill="#E0E0E0">• domain</text>
  <text x="550" y="155" font-family="Arial, sans-serif" font-size="11" text-anchor="middle" fill="#E0E0E0">• dispatcher</text>
  <text x="550" y="170" font-family="Arial, sans-serif" font-size="11" text-anchor="middle" fill="#E0E0E0">• location</text>
  <text x="550" y="185" font-family="Arial, sans-serif" font-size="11" text-anchor="middle" fill="#E0E0E0">Persistent Storage</text>
  
  <!-- Control Panel (optional, shown on the right) -->
  <rect x="750" y="60" width="200" height="140" rx="10" fill="#9F7AEA" stroke="#6B46C1" stroke-width="2" filter="url(#shadow)"/>
  <text x="850" y="90" font-family="Arial, sans-serif" font-size="16" font-weight="bold" text-anchor="middle" fill="white">Control Panel</text>
  <text x="850" y="115" font-family="Arial, sans-serif" font-size="12" text-anchor="middle" fill="white">Web UI</text>
  <text x="850" y="140" font-family="Arial, sans-serif" font-size="11" text-anchor="middle" fill="#F3E8FF">• Domain Management</text>
  <text x="850" y="155" font-family="Arial, sans-serif" font-size="11" text-anchor="middle" fill="#F3E8FF">• Dispatcher Config</text>
  <text x="850" y="170" font-family="Arial, sans-serif" font-size="11" text-anchor="middle" fill="#F3E8FF">• System Monitoring</text>
  <text x="850" y="185" font-family="Arial, sans-serif" font-size="11" text-anchor="middle" fill="#F3E8FF">nginx</text>
  
  <!-- Control Panel to MySQL Arrow -->
  <path d="M 750 130 L 650 130" stroke="#9F7AEA" stroke-width="2" fill="none" marker-end="url(#arrowhead)" marker-start="url(#arrowhead-reverse)"/>
  <text x="700" y="125" font-family="Arial, sans-serif" font-size="10" fill="#9F7AEA">Query</text>
  
  <!-- Internet/Endpoints -->
  <rect x="50" y="250" width="200" height="140" rx="10" fill="#E8E8E8" stroke="#333" stroke-width="2" filter="url(#shadow)"/>
  <text x="150" y="280" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="#333">Internet</text>
  <text x="150" y="305" font-family="Arial, sans-serif" font-size="12" text-anchor="middle" fill="#666">SIP Endpoints</text>
  <text x="150" y="330" font-family="Arial, sans-serif" font-size="12" text-anchor="middle" fill="#666">SIP Clients</text>
  <text x="150" y="345" font-family="Arial, sans-serif" font-size="12" text-anchor="middle" fill="#666">SIP Trunks</text>
  <text x="150" y="360" font-family="Arial, sans-serif" font-size="12" text-anchor="middle" fill="#666">VoIP Providers</text>
  <text x="150" y="375" font-family="Arial, sans-serif" font-size="12" text-anchor="middle" fill="#666">Endpoints</text>
  
  <!-- SIP Flow Arrow to PBX3sbc -->
  <path d="M 250 320 L 350 320" stroke="#4A90E2" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>
  <text x="300" y="310" font-family="Arial, sans-serif" font-size="11" fill="#4A90E2" font-weight="bold">SIP</text>
  
  <!-- PBX3sbc (OpenSIPS SBC) -->
  <rect x="350" y="250" width="200" height="140" rx="10" fill="url(#sbcGradient)" stroke="#2E5C8A" stroke-width="3" filter="url(#shadow)"/>
  <text x="450" y="280" font-family="Arial, sans-serif" font-size="18" font-weight="bold" text-anchor="middle" fill="white">PBX3sbc</text>
  <text x="450" y="305" font-family="Arial, sans-serif" font-size="12" text-anchor="middle" fill="white">OpenSIPS SBC</text>
  <text x="450" y="325" font-family="Arial, sans-serif" font-size="11" text-anchor="middle" fill="#E0E0E0">• Domain Validation</text>
  <text x="450" y="340" font-family="Arial, sans-serif" font-size="11" text-anchor="middle" fill="#E0E0E0">• Attack Mitigation</text>
  <text x="450" y="355" font-family="Arial, sans-serif" font-size="11" text-anchor="middle" fill="#E0E0E0">• Health Checks</text>
  <text x="450" y="370" font-family="Arial, sans-serif" font-size="11" text-anchor="middle" fill="#E0E0E0">• Load Balancing</text>
  
  <!-- Database Query Arrow (bidirectional) from PBX3sbc to MySQL -->
  <path d="M 450 250 L 550 200" stroke="#7B68EE" stroke-width="2" fill="none" marker-end="url(#arrowhead)" marker-start="url(#arrowhead-reverse)"/>
  <text x="500" y="220" font-family="Arial, sans-serif" font-size="10" fill="#7B68EE">Query</text>
  
  <!-- SIP Flow Arrow from PBX3sbc to PBX3 -->
  <path d="M 550 320 L 700 320" stroke="#4A90E2" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>
  <text x="625" y="310" font-family="Arial, sans-serif" font-size="11" fill="#4A90E2" font-weight="bold">SIP</text>
  
  <!-- Asterisk/PBX3 Backend Nodes -->
  <rect x="700" y="250" width="200" height="140" rx="10" fill="#E8E8E8" stroke="#333" stroke-width="2" filter="url(#shadow)"/>
  <text x="800" y="280" font-family="Arial, sans-serif" font-size="16" font-weight="bold" text-anchor="middle" fill="#333">PBX3 Nodes</text>
  <text x="800" y="305" font-family="Arial, sans-serif" font-size="12" text-anchor="middle" fill="#666">Asterisk Backends</text>
  <rect x="720" y="320" width="70" height="35" rx="5" fill="#D0D0D0" stroke="#999" stroke-width="1"/>
  <text x="755" y="340" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#333">Node 1</text>
  <text x="755" y="352" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#666">10.0.1.10</text>
  <rect x="810" y="320" width="70" height="35" rx="5" fill="#D0D0D0" stroke="#999" stroke-width="1"/>
  <text x="845" y="340" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#333">Node 2</text>
  <text x="845" y="352" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#666">10.0.1.11</text>
  <text x="800" y="370" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#666">Health Checks (OPTIONS)</text>
  
  <!-- RTP Bypass Flow (bidirectional arrow) -->
  <path d="M 150 450 L 800 450" stroke="#FF6B6B" stroke-width="2" fill="none" stroke-dasharray="5,5" marker-end="url(#arrowhead)" marker-start="url(#arrowhead-reverse)"/>
  <text x="475" y="428" font-family="Arial, sans-serif" font-size="11" fill="#FF6B6B" font-weight="bold">RTP Media</text>
  <text x="475" y="442" font-family="Arial, sans-serif" font-size="10" fill="#FF6B6B" font-style="italic">Direct: Endpoint ↔ Asterisk</text>
  <text x="475" y="468" font-family="Arial, sans-serif" font-size="9" fill="#CC5555">(Does not transit through OpenSIPS)</text>
  
  <!-- RTP Label -->
  <rect x="700" y="480" width="130" height="50" rx="5" fill="#FFE5E5" stroke="#FF6B6B" stroke-width="1"/>
  <text x="765" y="497" font-family="Arial, sans-serif" font-size="12" font-weight="bold" text-anchor="middle" fill="#FF6B6B">RTP Media</text>
  <text x="765" y="512" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#CC5555">Handled by</text>
  <text x="765" y="526" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#CC5555">Asterisk &amp; Endpoint</text>
  
  <!-- Legend -->
  <rect x="50" y="550" width="1500" height="260" rx="10" fill="white" stroke="#CCC" stroke-width="1" filter="url(#shadow)"/>
  <text x="800" y="575" font-family="Arial, sans-serif" font-size="16" font-weight="bold" text-anchor="middle" fill="#333">System Flow</text>
  
  <!-- Legend Items -->
  <path d="M 100 600 L 150 600" stroke="#4A90E2" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>
  <text x="160" y="605" font-family="Arial, sans-serif" font-size="12" fill="#333">SIP Signaling (through SBC)</text>
  
  <path d="M 100 625 L 150 625" stroke="#FF6B6B" stroke-width="2" fill="none" stroke-dasharray="5,5" marker-end="url(#arrowhead)"/>
  <text x="160" y="630" font-family="Arial, sans-serif" font-size="12" fill="#333">RTP Media (direct Endpoint ↔ Asterisk, does not transit OpenSIPS)</text>
  
  <path d="M 100 650 L 150 650" stroke="#7B68EE" stroke-width="2" fill="none" marker-end="url(#arrowhead)" marker-start="url(#arrowhead-reverse)"/>
  <text x="160" y="655" font-family="Arial, sans-serif" font-size="12" fill="#333">Database Queries (MySQL)</text>
  
  <path d="M 100 675 L 150 675" stroke="#9F7AEA" stroke-width="2" fill="none" marker-end="url(#arrowhead)" marker-start="url(#arrowhead-reverse)"/>
  <text x="160" y="680" font-family="Arial, sans-serif" font-size="12" fill="#333">Control Panel Database Access</text>
  
  <!-- Additional Info -->
  <text x="800" y="720" font-family="Arial, sans-serif" font-size="11" text-anchor="middle" fill="#666" font-style="italic">PBX3sbc provides domain validation, attack mitigation, and health-aware routing using OpenSIPS with MySQL database</text>
  
  <!-- Second column of legend for better use of space -->
  <path d="M 800 600 L 850 600" stroke="#4A90E2" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>
  <text x="860" y="605" font-family="Arial, sans-serif" font-size="12" fill="#333">SIP flows through PBX3sbc for security and routing</text>
  
  <path d="M 800 625 L 850 625" stroke="#FF6B6B" stroke-width="2" fill="none" stroke-dasharray="5,5" marker-end="url(#arrowhead)"/>
  <text x="860" y="630" font-family="Arial, sans-serif" font-size="12" fill="#333">RTP media handled directly by Asterisk and endpoint, OpenSIPS only processes SIP signaling</text>
  
  <path d="M 800 650 L 850 650" stroke="#7B68EE" stroke-width="2" fill="none" marker-end="url(#arrowhead)" marker-start="url(#arrowhead-reverse)"/>
  <text x="860" y="655" font-family="Arial, sans-serif" font-size="12" fill="#333">MySQL provides reliable routing and endpoint tracking</text>
  
  <path d="M 800 675 L 850 675" stroke="#9F7AEA" stroke-width="2" fill="none" marker-end="url(#arrowhead)" marker-start="url(#arrowhead-reverse)"/>
  <text x="860" y="680" font-family="Arial, sans-serif" font-size="12" fill="#333">Control Panel provides web-based management interface</text>
</svg>
